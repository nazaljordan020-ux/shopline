<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopLine - Order Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Created complete order management system for sellers -->
    
    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-sm">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="seller-dashboard.html" class="hover:underline">Seller Dashboard</a>
                <a href="home.html" class="hover:underline">Shop</a>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userDisplay"></span>
                <button id="logoutBtn" class="hover:underline">Logout</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="home.html" class="flex items-center space-x-2">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-xl font-bold">S</span>
                        </div>
                        <span class="text-2xl font-bold text-gray-800">ShopLine</span>
                    </a>
                    <span class="text-xl text-gray-600">Order Management</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Overview -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border-l-4 border-yellow-500">
                <p class="text-sm text-gray-600 mb-1">New Orders</p>
                <p class="text-3xl font-bold text-yellow-600" id="newOrdersCount">0</p>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-l-4 border-blue-500">
                <p class="text-sm text-gray-600 mb-1">To Ship</p>
                <p class="text-3xl font-bold text-blue-600" id="toShipCount">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-l-4 border-purple-500">
                <p class="text-sm text-gray-600 mb-1">Shipping</p>
                <p class="text-3xl font-bold text-purple-600" id="shippingCount">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border-l-4 border-green-500">
                <p class="text-sm text-gray-600 mb-1">Completed</p>
                <p class="text-3xl font-bold text-green-600" id="completedCount">0</p>
            </div>
        </div>

        <!-- Order Filters -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex items-center space-x-4">
                <button class="status-filter px-6 py-2 bg-orange-500 text-white rounded-lg font-semibold" data-status="all">
                    All Orders
                </button>
                <button class="status-filter px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" data-status="To Ship">
                    New Orders
                </button>
                <button class="status-filter px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" data-status="Shipped">
                    To Ship
                </button>
                <button class="status-filter px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" data-status="In Transit">
                    Shipping
                </button>
                <button class="status-filter px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" data-status="Completed">
                    Completed
                </button>
                <button class="status-filter px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" data-status="Cancelled">
                    Cancelled
                </button>
            </div>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="space-y-4">
            <!-- Orders will be loaded here -->
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Order Details</h3>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div id="orderDetails"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
           apiKey: "AIzaSyDo4y9nmVryC29QJMF66pA-pjo-tWAoeDY",
  authDomain: "shopline-7a14f.firebaseapp.com",
  projectId: "shopline-7a14f",
  storageBucket: "shopline-7a14f.firebasestorage.app",
  messagingSenderId: "1064176765834",
  appId: "1:1064176765834:web:f30944d3768599d137d673",
  measurementId: "G-49Q3CBV09C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allOrders = [];
        let currentFilter = 'all';

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;
            document.getElementById('userDisplay').textContent = user.displayName || user.email;
            loadOrders();
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });

        document.querySelectorAll('.status-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.status-filter').forEach(b => {
                    b.classList.remove('bg-orange-500', 'text-white');
                    b.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                });
                btn.classList.add('bg-orange-500', 'text-white');
                btn.classList.remove('bg-white', 'border', 'border-gray-300', 'text-gray-700');
                currentFilter = btn.dataset.status;
                displayOrders();
            });
        });

        async function loadOrders() {
            try {
                const ordersRef = collection(db, 'orders');
                const q = query(ordersRef, where('sellerId', '==', currentUser.uid));
                
                onSnapshot(q, (snapshot) => {
                    allOrders = [];
                    snapshot.forEach((doc) => {
                        allOrders.push({ id: doc.id, ...doc.data() });
                    });
                    
                    allOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    console.log('[v0] Loaded orders:', allOrders.length);
                    updateStats();
                    displayOrders();
                });
            } catch (error) {
                console.error('[v0] Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = `
                    <div class="bg-white rounded-lg p-8 text-center">
                        <p class="text-red-500">Failed to load orders. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function updateStats() {
            const newOrders = allOrders.filter(o => o.status === 'To Ship').length;
            const toShip = allOrders.filter(o => o.status === 'Shipped').length;
            const shipping = allOrders.filter(o => o.status === 'In Transit').length;
            const completed = allOrders.filter(o => o.status === 'Completed').length;

            document.getElementById('newOrdersCount').textContent = newOrders;
            document.getElementById('toShipCount').textContent = toShip;
            document.getElementById('shippingCount').textContent = shipping;
            document.getElementById('completedCount').textContent = completed;
        }

        function displayOrders() {
            const container = document.getElementById('ordersList');
            
            const filteredOrders = currentFilter === 'all' 
                ? allOrders 
                : allOrders.filter(o => o.status === currentFilter);

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg p-12 text-center">
                        <div class="text-6xl mb-4">ðŸ“¦</div>
                        <p class="text-gray-500 text-lg">No orders found</p>
                        <p class="text-gray-400 text-sm mt-2">Orders will appear here when customers make purchases</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredOrders.map(order => {
                const statusColors = {
                    'To Ship': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                    'Shipped': 'bg-blue-100 text-blue-800 border-blue-300',
                    'In Transit': 'bg-purple-100 text-purple-800 border-purple-300',
                    'Completed': 'bg-green-100 text-green-800 border-green-300',
                    'Cancelled': 'bg-red-100 text-red-800 border-red-300'
                };

                return `
                    <div class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Order #${order.id.substring(0, 8).toUpperCase()}</p>
                                <p class="text-xs text-gray-400">${new Date(order.createdAt).toLocaleString()}</p>
                            </div>
                            <span class="px-3 py-1 ${statusColors[order.status]} border rounded-full text-xs font-semibold">
                                ${order.status}
                            </span>
                        </div>

                        <div class="mb-4">
                            <p class="font-semibold text-gray-800">Customer: ${order.buyerName}</p>
                            <p class="text-sm text-gray-600">Items: ${order.items.length}</p>
                            <p class="text-sm text-gray-600">Payment: ${order.paymentMethod}</p>
                            <p class="text-sm text-gray-600">Courier: ${order.courier}</p>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t">
                            <div>
                                <p class="text-sm text-gray-600">Total Amount</p>
                                <p class="text-2xl font-bold text-orange-500">â‚±${order.total.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="viewOrderDetails('${order.id}')"
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition"
                                >
                                    View Details
                                </button>
                                ${order.status === 'To Ship' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'Shipped')"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                    >
                                        Mark as Shipped
                                    </button>
                                ` : ''}
                                ${order.status === 'Shipped' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'In Transit')"
                                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition"
                                    >
                                        In Transit
                                    </button>
                                ` : ''}
                                ${order.status === 'In Transit' ? `
                                    <button 
                                        onclick="updateOrderStatus('${order.id}', 'Completed')"
                                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
                                    >
                                        Complete Order
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.viewOrderDetails = (orderId) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const modal = document.getElementById('orderModal');
            const details = document.getElementById('orderDetails');

            details.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Order Information</h4>
                        <p class="text-sm"><span class="font-medium">Order ID:</span> #${order.id.substring(0, 8).toUpperCase()}</p>
                        <p class="text-sm"><span class="font-medium">Date:</span> ${new Date(order.createdAt).toLocaleString()}</p>
                        <p class="text-sm"><span class="font-medium">Status:</span> ${order.status}</p>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Customer Information</h4>
                        <p class="text-sm"><span class="font-medium">Name:</span> ${order.buyerName}</p>
                        <p class="text-sm"><span class="font-medium">Delivery Address:</span></p>
                        <p class="text-sm text-gray-600 ml-4">${order.deliveryAddress}</p>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Order Items</h4>
                        ${order.items.map(item => `
                            <div class="flex items-center gap-3 mb-2 pb-2 border-b last:border-0">
                                <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded">
                                <div class="flex-1">
                                    <p class="text-sm font-medium">${item.name}</p>
                                    <p class="text-xs text-gray-500">Qty: ${item.quantity} x â‚±${item.price}</p>
                                </div>
                                <p class="text-sm font-bold text-orange-500">â‚±${(item.price * item.quantity).toFixed(2)}</p>
                            </div>
                        `).join('')}
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Shipping & Payment</h4>
                        <p class="text-sm"><span class="font-medium">Courier:</span> ${order.courier}</p>
                        <p class="text-sm"><span class="font-medium">Payment Method:</span> ${order.paymentMethod}</p>
                        <div class="mt-3 pt-3 border-t">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Subtotal:</span>
                                <span>â‚±${order.subtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Shipping Fee:</span>
                                <span>â‚±${order.shippingFee.toFixed(2)}</span>
                            </div>
                            ${order.discount > 0 ? `
                                <div class="flex justify-between text-sm mb-1 text-green-600">
                                    <span>Discount:</span>
                                    <span>-â‚±${order.discount.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between font-bold text-lg mt-2 pt-2 border-t">
                                <span>Total:</span>
                                <span class="text-orange-500">â‚±${order.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        };

        window.updateOrderStatus = async (orderId, newStatus) => {
            if (!confirm(`Update order status to "${newStatus}"?`)) return;

            try {
                await updateDoc(doc(db, 'orders', orderId), {
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                
                console.log('[v0] Order status updated:', orderId, newStatus);
                alert(`Order status updated to "${newStatus}"`);
            } catch (error) {
                console.error('[v0] Error updating order:', error);
                alert('Failed to update order status. Please try again.');
            }
        };

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('orderModal').classList.add('hidden');
        });

        document.getElementById('orderModal').addEventListener('click', (e) => {
            if (e.target.id === 'orderModal') {
                document.getElementById('orderModal').classList.add('hidden');
            }
        });
    </script>
</body>
</html>

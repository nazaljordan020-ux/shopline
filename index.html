<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopLine - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Created complete admin panel for platform management -->
    
    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white text-sm">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span class="font-semibold">Admin Panel</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="adminDisplay"></span>
                <button id="logoutBtn" class="hover:underline">Logout</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-gray-700 to-gray-900 rounded-lg flex items-center justify-center">
                    <span class="text-white text-xl font-bold">A</span>
                </div>
                <span class="text-2xl font-bold text-gray-800">ShopLine Admin</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Platform Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-lg shadow-lg text-white">
                <p class="text-sm mb-1">Total Users</p>
                <p class="text-4xl font-bold" id="totalUsers">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-lg shadow-lg text-white">
                <p class="text-sm mb-1">Total Orders</p>
                <p class="text-4xl font-bold" id="totalOrders">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-lg shadow-lg text-white">
                <p class="text-sm mb-1">Total Products</p>
                <p class="text-4xl font-bold" id="totalProducts">0</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-red-500 p-6 rounded-lg shadow-lg text-white">
                <p class="text-sm mb-1">Platform Revenue</p>
                <p class="text-3xl font-bold">₱<span id="platformRevenue">0</span></p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="flex border-b">
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-orange-500 text-orange-500" data-tab="overview">
                    Overview
                </button>
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="users">
                    Users
                </button>
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="products">
                    Products
                </button>
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="orders">
                    Orders
                </button>
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="withdrawals">
                    Withdrawals
                </button>
                <button class="admin-tab px-6 py-4 font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="disputes">
                    Disputes
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
         apiKey: "AIzaSyDo4y9nmVryC29QJMF66pA-pjo-tWAoeDY",
  authDomain: "shopline-7a14f.firebaseapp.com",
  projectId: "shopline-7a14f",
  storageBucket: "shopline-7a14f.firebasestorage.app",
  messagingSenderId: "1064176765834",
  appId: "1:1064176765834:web:f30944d3768599d137d673",
  measurementId: "G-49Q3CBV09C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentTab = 'overview';
        let platformData = {
            users: [],
            products: [],
            orders: [],
            withdrawals: []
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('adminDisplay').textContent = user.displayName || user.email;
            await loadPlatformData();
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });

        document.querySelectorAll('.admin-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(b => {
                    b.classList.remove('border-orange-500', 'text-orange-500');
                    b.classList.add('border-transparent', 'text-gray-600');
                });
                btn.classList.add('border-orange-500', 'text-orange-500');
                btn.classList.remove('border-transparent', 'text-gray-600');
                currentTab = btn.dataset.tab;
                renderTabContent();
            });
        });

        async function loadPlatformData() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                platformData.users = [];
                usersSnapshot.forEach((doc) => {
                    platformData.users.push({ id: doc.id, ...doc.data() });
                });

                const productsSnapshot = await getDocs(collection(db, 'products'));
                platformData.products = [];
                productsSnapshot.forEach((doc) => {
                    platformData.products.push({ id: doc.id, ...doc.data() });
                });

                const ordersSnapshot = await getDocs(collection(db, 'orders'));
                platformData.orders = [];
                let totalRevenue = 0;
                ordersSnapshot.forEach((doc) => {
                    const order = { id: doc.id, ...doc.data() };
                    platformData.orders.push(order);
                    if (order.status === 'Completed') {
                        totalRevenue += order.total || 0;
                    }
                });

                const withdrawalsSnapshot = await getDocs(collection(db, 'withdrawals'));
                platformData.withdrawals = [];
                withdrawalsSnapshot.forEach((doc) => {
                    platformData.withdrawals.push({ id: doc.id, ...doc.data() });
                });

                document.getElementById('totalUsers').textContent = platformData.users.length;
                document.getElementById('totalOrders').textContent = platformData.orders.length;
                document.getElementById('totalProducts').textContent = platformData.products.length;
                document.getElementById('platformRevenue').textContent = totalRevenue.toFixed(2);

                console.log('[v0] Platform data loaded');
                renderTabContent();
            } catch (error) {
                console.error('[v0] Error loading platform data:', error);
            }
        }

        function renderTabContent() {
            const content = document.getElementById('tabContent');

            switch(currentTab) {
                case 'overview':
                    content.innerHTML = renderOverview();
                    break;
                case 'users':
                    content.innerHTML = renderUsers();
                    break;
                case 'products':
                    content.innerHTML = renderProducts();
                    break;
                case 'orders':
                    content.innerHTML = renderOrders();
                    break;
                case 'withdrawals':
                    content.innerHTML = renderWithdrawals();
                    break;
                case 'disputes':
                    content.innerHTML = renderDisputes();
                    break;
            }
        }

        function renderOverview() {
            const recentOrders = platformData.orders.slice(0, 10);
            const topSellers = [...platformData.users]
                .filter(u => u.role === 'buyer')
                .sort((a, b) => (b.referralCount || 0) - (a.referralCount || 0))
                .slice(0, 5);

            return `
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Orders</h3>
                        <div class="space-y-3">
                            ${recentOrders.map(order => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <div>
                                        <p class="text-sm font-medium">#${order.id.substring(0, 8).toUpperCase()}</p>
                                        <p class="text-xs text-gray-500">${order.buyerName}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-orange-500">₱${order.total.toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">${order.status}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Top Referrers</h3>
                        <div class="space-y-3">
                            ${topSellers.map((user, index) => `
                                <div class="flex justify-between items-center py-2 border-b">
                                    <div class="flex items-center gap-3">
                                        <span class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-sm font-bold text-orange-600">${index + 1}</span>
                                        <div>
                                            <p class="text-sm font-medium">${user.username}</p>
                                            <p class="text-xs text-gray-500">${user.email}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold">${user.referralCount || 0} referrals</p>
                                        <p class="text-xs text-green-600">₱${(user.totalCommissionEarned || 0).toFixed(2)}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUsers() {
            return `
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-800">User Management</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Referrals</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${platformData.users.map(user => `
                                    <tr>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-800">${user.username}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${user.email}</td>
                                        <td class="px-6 py-4 text-sm">
                                            <span class="px-2 py-1 ${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'} rounded-full text-xs">
                                                ${user.role}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${user.referralCount || 0}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${new Date(user.createdAt).toLocaleDateString()}</td>
                                        <td class="px-6 py-4 text-sm">
                                            <button onclick="viewUser('${user.id}')" class="text-blue-600 hover:text-blue-800 mr-2">View</button>
                                            <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderProducts() {
            return `
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-800">Product Management</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Seller</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${platformData.products.map(product => `
                                    <tr>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
                                                <span class="text-sm font-medium text-gray-800">${product.name}</span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${product.category}</td>
                                        <td class="px-6 py-4 text-sm font-semibold text-orange-500">₱${product.price}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${product.stock}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${product.sellerName}</td>
                                        <td class="px-6 py-4 text-sm">
                                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderOrders() {
            return `
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-800">Order Management</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Buyer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${platformData.orders.map(order => `
                                    <tr>
                                        <td class="px-6 py-4 text-sm font-medium text-gray-800">#${order.id.substring(0, 8).toUpperCase()}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${order.buyerName}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${order.items.length}</td>
                                        <td class="px-6 py-4 text-sm font-semibold text-orange-500">₱${order.total.toFixed(2)}</td>
                                        <td class="px-6 py-4 text-sm">
                                            <span class="px-2 py-1 bg-${order.status === 'Completed' ? 'green' : 'blue'}-100 text-${order.status === 'Completed' ? 'green' : 'blue'}-800 rounded-full text-xs">
                                                ${order.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${new Date(order.createdAt).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderWithdrawals() {
            return `
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold text-gray-800">Withdrawal Requests</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bank Account</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${platformData.withdrawals.map(withdrawal => `
                                    <tr>
                                        <td class="px-6 py-4 text-sm text-gray-800">${withdrawal.userId.substring(0, 8)}</td>
                                        <td class="px-6 py-4 text-sm font-semibold text-orange-500">₱${withdrawal.amount.toFixed(2)}</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${withdrawal.bankAccount}</td>
                                        <td class="px-6 py-4 text-sm">
                                            <span class="px-2 py-1 bg-${withdrawal.status === 'approved' ? 'green' : withdrawal.status === 'pending' ? 'yellow' : 'red'}-100 text-${withdrawal.status === 'approved' ? 'green' : withdrawal.status === 'pending' ? 'yellow' : 'red'}-800 rounded-full text-xs">
                                                ${withdrawal.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">${new Date(withdrawal.createdAt).toLocaleDateString()}</td>
                                        <td class="px-6 py-4 text-sm">
                                            ${withdrawal.status === 'pending' ? `
                                                <button onclick="approveWithdrawal('${withdrawal.id}')" class="text-green-600 hover:text-green-800 mr-2">Approve</button>
                                                <button onclick="rejectWithdrawal('${withdrawal.id}')" class="text-red-600 hover:text-red-800">Reject</button>
                                            ` : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderDisputes() {
            return `
                <div class="bg-white rounded-lg shadow-sm p-12 text-center">
                    <div class="text-6xl mb-4">⚖️</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Dispute Management</h3>
                    <p class="text-gray-600">No active disputes at the moment</p>
                </div>
            `;
        }

        window.deleteProduct = async (productId) => {
            if (!confirm('Delete this product? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, 'products', productId));
                console.log('[v0] Product deleted:', productId);
                alert('Product deleted successfully');
                await loadPlatformData();
            } catch (error) {
                console.error('[v0] Error deleting product:', error);
                alert('Failed to delete product');
            }
        };

        window.deleteUser = async (userId) => {
            if (!confirm('Delete this user? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, 'users', userId));
                console.log('[v0] User deleted:', userId);
                alert('User deleted successfully');
                await loadPlatformData();
            } catch (error) {
                console.error('[v0] Error deleting user:', error);
                alert('Failed to delete user');
            }
        };

        window.approveWithdrawal = async (withdrawalId) => {
            if (!confirm('Approve this withdrawal request?')) return;

            try {
                await updateDoc(doc(db, 'withdrawals', withdrawalId), {
                    status: 'approved',
                    approvedAt: new Date().toISOString()
                });
                console.log('[v0] Withdrawal approved:', withdrawalId);
                alert('Withdrawal approved');
                await loadPlatformData();
            } catch (error) {
                console.error('[v0] Error approving withdrawal:', error);
                alert('Failed to approve withdrawal');
            }
        };

        window.rejectWithdrawal = async (withdrawalId) => {
            if (!confirm('Reject this withdrawal request?')) return;

            try {
                await updateDoc(doc(db, 'withdrawals', withdrawalId), {
                    status: 'rejected',
                    rejectedAt: new Date().toISOString()
                });
                console.log('[v0] Withdrawal rejected:', withdrawalId);
                alert('Withdrawal rejected');
                await loadPlatformData();
            } catch (error) {
                console.error('[v0] Error rejecting withdrawal:', error);
                alert('Failed to reject withdrawal');
            }
        };

        window.viewUser = (userId) => {
            const user = platformData.users.find(u => u.id === userId);
            if (user) {
                alert(`User Details:\n\nName: ${user.username}\nEmail: ${user.email}\nRole: ${user.role}\nReferrals: ${user.referralCount || 0}\nCommission Earned: ₱${(user.totalCommissionEarned || 0).toFixed(2)}`);
            }
        };
    </script>
</body>
</html>

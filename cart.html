<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart - ShopLine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-btn { background: linear-gradient(to right, #f97316, #ef4444); }
    .gradient-btn:hover { background: linear-gradient(to right, #ea580c, #dc2626); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <a href="index.html" class="text-2xl font-bold">ShopLine</a>
        <nav class="flex items-center space-x-6">
          <a href="marketplace.html" class="hover:text-orange-200">Marketplace</a>
          <a href="cart.html" class="hover:text-orange-200 font-semibold flex items-center gap-1">
            Cart <span id="cart-count" class="bg-yellow-400 text-orange-800 text-xs px-2 py-0.5 rounded-full ml-1">0</span>
          </a>
          <a href="seller.html" class="hover:text-orange-200">Seller Center</a>
          <div id="auth-section"></div>
        </nav>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Shopping Cart</h1>

    <div class="flex gap-6">
      <!-- Cart Items -->
      <div class="flex-1">
        <div id="cart-items" class="bg-white rounded-lg shadow-sm">
          <div class="p-12 text-center">
            <div class="text-6xl mb-4">ðŸ›’</div>
            <p class="text-gray-500 mb-4">Your cart is empty</p>
            <a href="marketplace.html" class="inline-block gradient-btn text-white px-6 py-3 rounded-lg">Start Shopping</a>
          </div>
        </div>

        <!-- Voucher -->
        <div id="voucher-section" class="hidden bg-white rounded-lg shadow-sm p-4 mt-4">
          <div class="flex items-center gap-4">
            <span class="text-gray-700 font-semibold">Voucher:</span>
            <input type="text" id="voucher-code" placeholder="Enter Voucher Code" class="flex-1 px-4 py-2 border rounded focus:outline-none focus:border-orange-500">
            <button onclick="applyVoucher()" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">Apply</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Try: SAVE10 or SAVE20</p>
        </div>
      </div>

      <!-- Order Summary -->
      <div id="order-summary" class="hidden w-96">
        <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
          <h3 class="text-lg font-semibold mb-4">Order Summary</h3>

          <div class="space-y-3 mb-4">
            <div class="flex justify-between text-gray-600">
              <span>Subtotal (<span id="total-items">0</span> items)</span>
              <span id="subtotal">â‚±0.00</span>
            </div>
            <div class="flex justify-between text-gray-600">
              <span>Shipping Fee</span>
              <span id="shipping-fee">â‚±50</span>
            </div>
            <div id="discount-row" class="hidden flex justify-between text-green-600">
              <span>Voucher Discount</span>
              <span id="discount-amount">-â‚±0.00</span>
            </div>
          </div>

          <div class="border-t pt-4 mb-4">
            <div class="flex justify-between text-xl font-bold">
              <span>Total</span>
              <span id="total" class="text-orange-500">â‚±0.00</span>
            </div>
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Address</label>
              <textarea id="delivery-address" rows="3" placeholder="Enter your delivery address" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Courier</label>
              <select id="courier" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500">
                <option value="SPX">SPX Express (â‚±50)</option>
                <option value="Flash">Flash Express (â‚±60)</option>
                <option value="J&T">J&T Express (â‚±55)</option>
                <option value="2GO">2GO Express (â‚±70)</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
              <select id="payment-method" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500">
                <option value="COD">Cash on Delivery (COD)</option>
                <option value="Card">Credit/Debit Card</option>
                <option value="Wallet">ShopLine Wallet</option>
                <option value="Bank">Bank Transfer</option>
              </select>
            </div>

            <button id="checkout-btn" onclick="checkout()" class="w-full gradient-btn text-white py-3 rounded-lg font-semibold">PLACE ORDER</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDo4y9nmVryC29QJMF66pA-pjo-tWAoeDY",
      authDomain: "shopline-7a14f.firebaseapp.com",
      projectId: "shopline-7a14f",
      storageBucket: "shopline-7a14f.firebasestorage.app",
      messagingSenderId: "1064176765834",
      appId: "1:1064176765834:web:f30944d3768599d137d673",
      measurementId: "G-49Q3CBV09C"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let cart = [];
    let voucherDiscount = 0;

    const SHIPPING_FEES = { SPX: 50, Flash: 60, 'J&T': 55, '2GO': 70 };

    // Auth State
    auth.onAuthStateChanged(user => {
      currentUser = user;
      const authSection = document.getElementById('auth-section');
      if (user) {
        authSection.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="text-sm">${user.displayName || user.email}</span>
            <button onclick="auth.signOut()" class="bg-white/20 px-3 py-1 rounded hover:bg-white/30">Sign Out</button>
          </div>
        `;
      } else {
        authSection.innerHTML = `<a href="index.html" class="bg-white text-orange-500 px-4 py-2 rounded-lg font-semibold hover:bg-orange-50">Sign In</a>`;
      }
      loadCart();
    });

    function loadCart() {
      cart = JSON.parse(localStorage.getItem('cart') || '[]');
      renderCart();
      updateCartCount();
    }

    function renderCart() {
      const container = document.getElementById('cart-items');
      const summaryDiv = document.getElementById('order-summary');
      const voucherSection = document.getElementById('voucher-section');

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="p-12 text-center">
            <div class="text-6xl mb-4">ðŸ›’</div>
            <p class="text-gray-500 mb-4">Your cart is empty</p>
            <a href="marketplace.html" class="inline-block gradient-btn text-white px-6 py-3 rounded-lg">Start Shopping</a>
          </div>
        `;
        summaryDiv.classList.add('hidden');
        voucherSection.classList.add('hidden');
        return;
      }

      summaryDiv.classList.remove('hidden');
      voucherSection.classList.remove('hidden');

      container.innerHTML = `<div class="divide-y">${cart.map((item, index) => `
        <div class="p-4 flex items-center">
          <img src="${item.image || 'https://placehold.co/80x80?text=Product'}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4">
          <div class="flex-1">
            <h4 class="font-medium text-gray-800">${item.name}</h4>
            <p class="text-sm text-gray-500">Variation: ${item.variation || 'Default'}</p>
          </div>
          <div class="w-24 text-center text-orange-500 font-semibold">â‚±${item.price?.toLocaleString() || 0}</div>
          <div class="w-32 flex items-center justify-center">
            <button onclick="updateQuantity(${index}, -1)" class="px-3 py-1 border rounded-l hover:bg-gray-50">-</button>
            <span class="w-12 text-center border-t border-b py-1">${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="px-3 py-1 border rounded-r hover:bg-gray-50">+</button>
          </div>
          <div class="w-24 text-center text-orange-500 font-bold">â‚±${(item.price * item.quantity).toLocaleString()}</div>
          <button onclick="removeItem(${index})" class="w-10 text-red-500 hover:text-red-700">
            <svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
        </div>
      `).join('')}</div>`;

      updateSummary();
    }

    function updateQuantity(index, delta) {
      cart[index].quantity = Math.max(1, cart[index].quantity + delta);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }

    function removeItem(index) {
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      updateCartCount();
      alert('Item removed from cart');
    }

    function applyVoucher() {
      const code = document.getElementById('voucher-code').value.toUpperCase();
      if (code === 'SAVE10') {
        voucherDiscount = 0.1;
        alert('Voucher applied! 10% discount');
      } else if (code === 'SAVE20') {
        voucherDiscount = 0.2;
        alert('Voucher applied! 20% discount');
      } else {
        voucherDiscount = 0;
        alert('Invalid voucher code');
      }
      updateSummary();
    }

    function updateSummary() {
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const courier = document.getElementById('courier').value;
      const shippingFee = SHIPPING_FEES[courier] || 50;
      const discount = subtotal * voucherDiscount;
      const total = subtotal + shippingFee - discount;

      document.getElementById('total-items').textContent = totalItems;
      document.getElementById('subtotal').textContent = `â‚±${subtotal.toLocaleString()}`;
      document.getElementById('shipping-fee').textContent = `â‚±${shippingFee}`;
      
      const discountRow = document.getElementById('discount-row');
      if (discount > 0) {
        discountRow.classList.remove('hidden');
        discountRow.classList.add('flex');
        document.getElementById('discount-amount').textContent = `-â‚±${discount.toLocaleString()}`;
      } else {
        discountRow.classList.add('hidden');
        discountRow.classList.remove('flex');
      }
      
      document.getElementById('total').textContent = `â‚±${total.toLocaleString()}`;
    }

    document.getElementById('courier').onchange = updateSummary;

    async function checkout() {
      if (!currentUser) {
        alert('Please sign in to place an order');
        window.location.href = 'index.html';
        return;
      }

      const address = document.getElementById('delivery-address').value.trim();
      if (!address) {
        alert('Please enter delivery address');
        return;
      }

      const btn = document.getElementById('checkout-btn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const courier = document.getElementById('courier').value;
        const paymentMethod = document.getElementById('payment-method').value;
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const shippingFee = SHIPPING_FEES[courier] || 50;
        const discount = subtotal * voucherDiscount;

        // Group items by seller
        const sellerOrders = {};
        cart.forEach(item => {
          if (!sellerOrders[item.sellerId]) {
            sellerOrders[item.sellerId] = [];
          }
          sellerOrders[item.sellerId].push(item);
        });

        // Create order for each seller
        for (const [sellerId, items] of Object.entries(sellerOrders)) {
          const itemSubtotal = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
          const itemDiscount = itemSubtotal * voucherDiscount;
          const orderTotal = itemSubtotal + shippingFee - itemDiscount;

          const orderRef = await db.collection('orders').add({
            buyerId: currentUser.uid,
            buyerName: currentUser.displayName || currentUser.email,
            sellerId,
            items,
            deliveryAddress: address,
            courier,
            paymentMethod,
            subtotal: itemSubtotal,
            shippingFee,
            discount: itemDiscount,
            total: orderTotal,
            status: 'To Ship',
            createdAt: new Date().toISOString()
          });

          // Create notification for seller
          await db.collection('notifications').add({
            userId: sellerId,
            type: 'new_order',
            title: 'New Order Received!',
            message: `${currentUser.displayName || currentUser.email} placed an order for â‚±${orderTotal.toFixed(2)}`,
            orderId: orderRef.id,
            read: false,
            createdAt: new Date().toISOString()
          });
        }

        // Clear cart
        localStorage.setItem('cart', '[]');
        cart = [];

        alert('Order placed successfully!');
        window.location.href = 'orders.html';
      } catch (error) {
        alert('Failed to place order: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'PLACE ORDER';
      }
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cart-count').textContent = count;
    }
  </script>
</body>
</html>

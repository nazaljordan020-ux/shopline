<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopLine - Shopping Cart</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Created complete shopping cart and checkout page -->
    
    <!-- Top Bar -->
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-sm">
        <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="seller-dashboard.html" class="hover:underline">Seller Centre</a>
                <a href="home.html" class="hover:underline">Home</a>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userDisplay"></span>
                <button id="logoutBtn" class="hover:underline">Logout</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center space-x-4">
                <a href="home.html" class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-xl font-bold">S</span>
                    </div>
                    <span class="text-2xl font-bold text-gray-800">ShopLine</span>
                </a>
                <span class="text-xl text-gray-800">Shopping Cart</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="flex gap-6">
            <!-- Cart Items -->
            <div class="flex-1">
                <div class="bg-white rounded-lg shadow-sm mb-4">
                    <div class="p-4 border-b flex items-center">
                        <input type="checkbox" id="selectAll" class="mr-3">
                        <span class="flex-1 text-gray-700 font-semibold">Product</span>
                        <span class="w-24 text-center text-gray-700">Unit Price</span>
                        <span class="w-32 text-center text-gray-700">Quantity</span>
                        <span class="w-24 text-center text-gray-700">Total</span>
                        <span class="w-16 text-center text-gray-700">Actions</span>
                    </div>
                    <div id="cartItems" class="divide-y">
                        <!-- Cart items will be loaded here -->
                    </div>
                </div>

                <!-- Voucher Section -->
                <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                    <div class="flex items-center gap-4">
                        <span class="text-gray-700 font-semibold">ShopLine Voucher:</span>
                        <input 
                            type="text" 
                            id="voucherCode"
                            placeholder="Enter Voucher Code"
                            class="flex-1 px-4 py-2 border rounded focus:outline-none focus:border-orange-500"
                        >
                        <button id="applyVoucher" class="px-6 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                            Apply
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="w-96">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
                    <h3 class="text-lg font-semibold mb-4">Order Summary</h3>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal (<span id="itemCount">0</span> items)</span>
                            <span id="subtotal">‚Ç±0</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Shipping Fee</span>
                            <span id="shippingFee">‚Ç±0</span>
                        </div>
                        <div class="flex justify-between text-green-600">
                            <span>Voucher Discount</span>
                            <span id="discount">-‚Ç±0</span>
                        </div>
                    </div>

                    <div class="border-t pt-4 mb-4">
                        <div class="flex justify-between text-xl font-bold">
                            <span>Total</span>
                            <span class="text-orange-500" id="total">‚Ç±0</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Address</label>
                            <textarea 
                                id="deliveryAddress"
                                rows="3"
                                placeholder="Enter your delivery address"
                                class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500"
                                required
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Courier</label>
                            <select id="courier" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500">
                                <option value="SPX">SPX Express (‚Ç±50)</option>
                                <option value="Flash">Flash Express (‚Ç±60)</option>
                                <option value="J&T">J&T Express (‚Ç±55)</option>
                                <option value="2GO">2GO Express (‚Ç±70)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                            <select id="paymentMethod" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-orange-500">
                                <option value="COD">Cash on Delivery (COD)</option>
                                <option value="Card">Credit/Debit Card</option>
                                <option value="Wallet">ShopLine Wallet</option>
                                <option value="Bank">Bank Transfer</option>
                            </select>
                        </div>

                        <button 
                            id="checkoutBtn"
                            class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 rounded font-semibold hover:from-orange-600 hover:to-red-600 transition"
                        >
                            PLACE ORDER
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDo4y9nmVryC29QJMF66pA-pjo-tWAoeDY",
  authDomain: "shopline-7a14f.firebaseapp.com",
  projectId: "shopline-7a14f",
  storageBucket: "shopline-7a14f.firebasestorage.app",
  messagingSenderId: "1064176765834",
  appId: "1:1064176765834:web:f30944d3768599d137d673",
  measurementId: "G-49Q3CBV09C"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let cart = [];
        let voucherDiscount = 0;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;
            document.getElementById('userDisplay').textContent = user.displayName || user.email;
            loadCart();
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });

        function loadCart() {
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
            displayCart();
            updateSummary();
        }

        function displayCart() {
            const container = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <div class="text-6xl mb-4">üõí</div>
                        <p class="text-gray-500 mb-4">Your cart is empty</p>
                        <a href="home.html" class="inline-block px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                            Start Shopping
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = cart.map((item, index) => `
                <div class="p-4 flex items-center">
                    <input type="checkbox" class="item-select mr-3" data-index="${index}" checked>
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded mr-4">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-500">Variation: ${item.variation || 'Default'}</p>
                    </div>
                    <div class="w-24 text-center text-orange-500 font-semibold">‚Ç±${item.price}</div>
                    <div class="w-32 flex items-center justify-center">
                        <button class="qty-btn px-3 py-1 border rounded-l" data-index="${index}" data-action="decrease">-</button>
                        <input type="number" value="${item.quantity}" min="1" class="w-16 px-2 py-1 border-t border-b text-center qty-input" data-index="${index}" readonly>
                        <button class="qty-btn px-3 py-1 border rounded-r" data-index="${index}" data-action="increase">+</button>
                    </div>
                    <div class="w-24 text-center text-orange-500 font-bold">‚Ç±${(item.price * item.quantity).toFixed(2)}</div>
                    <div class="w-16 text-center">
                        <button class="remove-btn text-red-500 hover:text-red-700" data-index="${index}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.qty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const action = e.target.dataset.action;
                    
                    if (action === 'increase') {
                        cart[index].quantity++;
                    } else if (action === 'decrease' && cart[index].quantity > 1) {
                        cart[index].quantity--;
                    }
                    
                    saveCart();
                    displayCart();
                    updateSummary();
                });
            });

            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    cart.splice(index, 1);
                    saveCart();
                    displayCart();
                    updateSummary();
                });
            });

            document.querySelectorAll('.item-select').forEach(checkbox => {
                checkbox.addEventListener('change', updateSummary);
            });
        }

        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.item-select').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateSummary();
        });

        document.getElementById('courier').addEventListener('change', updateSummary);

        document.getElementById('applyVoucher').addEventListener('click', () => {
            const code = document.getElementById('voucherCode').value.trim();
            if (code === 'SAVE10') {
                voucherDiscount = 0.10;
                alert('Voucher applied! 10% discount');
            } else if (code === 'SAVE20') {
                voucherDiscount = 0.20;
                alert('Voucher applied! 20% discount');
            } else if (code) {
                alert('Invalid voucher code');
                voucherDiscount = 0;
            }
            updateSummary();
        });

        function updateSummary() {
            const selectedItems = Array.from(document.querySelectorAll('.item-select:checked')).map(cb => 
                cart[parseInt(cb.dataset.index)]
            );

            const subtotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const courier = document.getElementById('courier').value;
            const shippingFee = courier === '2GO' ? 70 : courier === 'Flash' ? 60 : courier === 'J&T' ? 55 : 50;
            const discount = subtotal * voucherDiscount;
            const total = subtotal + shippingFee - discount;

            document.getElementById('itemCount').textContent = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('subtotal').textContent = `‚Ç±${subtotal.toFixed(2)}`;
            document.getElementById('shippingFee').textContent = `‚Ç±${shippingFee}`;
            document.getElementById('discount').textContent = `-‚Ç±${discount.toFixed(2)}`;
            document.getElementById('total').textContent = `‚Ç±${total.toFixed(2)}`;
        }

        document.getElementById('checkoutBtn').addEventListener('click', async () => {
            const address = document.getElementById('deliveryAddress').value.trim();
            if (!address) {
                alert('Please enter delivery address');
                return;
            }

            const selectedItems = Array.from(document.querySelectorAll('.item-select:checked')).map(cb => 
                cart[parseInt(cb.dataset.index)]
            );

            if (selectedItems.length === 0) {
                alert('Please select items to checkout');
                return;
            }

            const courier = document.getElementById('courier').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const subtotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shippingFee = courier === '2GO' ? 70 : courier === 'Flash' ? 60 : courier === 'J&T' ? 55 : 50;
            const discount = subtotal * voucherDiscount;
            const total = subtotal + shippingFee - discount;

            try {
                // Create order for each seller
                const sellerOrders = {};
                selectedItems.forEach(item => {
                    if (!sellerOrders[item.sellerId]) {
                        sellerOrders[item.sellerId] = [];
                    }
                    sellerOrders[item.sellerId].push(item);
                });

                for (const [sellerId, items] of Object.entries(sellerOrders)) {
                    await addDoc(collection(db, 'orders'), {
                        buyerId: currentUser.uid,
                        buyerName: currentUser.displayName || currentUser.email,
                        sellerId: sellerId,
                        items: items,
                        deliveryAddress: address,
                        courier: courier,
                        paymentMethod: paymentMethod,
                        subtotal: items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                        shippingFee: shippingFee,
                        discount: discount,
                        total: total,
                        status: 'To Ship',
                        createdAt: new Date().toISOString()
                    });

                    // Award referral commission if buyer was referred
                    const buyerDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    if (buyerDoc.exists() && buyerDoc.data().referredBy) {
                        const referrerId = buyerDoc.data().referredBy;
                        const commission = total * 0.05;
                        
                        await addDoc(collection(db, 'commissions'), {
                            referrerId: referrerId,
                            buyerId: currentUser.uid,
                            orderId: sellerId,
                            amount: commission,
                            orderTotal: total,
                            createdAt: new Date().toISOString()
                        });

                        const referrerDoc = await getDoc(doc(db, 'users', referrerId));
                        if (referrerDoc.exists()) {
                            const currentCommission = referrerDoc.data().totalCommissionEarned || 0;
                            await setDoc(doc(db, 'users', referrerId), {
                                totalCommissionEarned: currentCommission + commission
                            }, { merge: true });
                        }

                        console.log('[v0] Referral commission awarded:', commission);
                    }
                }

                // Remove ordered items from cart
                const selectedIndices = Array.from(document.querySelectorAll('.item-select:checked')).map(cb => 
                    parseInt(cb.dataset.index)
                ).sort((a, b) => b - a);
                
                selectedIndices.forEach(index => cart.splice(index, 1));
                saveCart();

                alert('Order placed successfully! The seller will process your order shortly.');
                window.location.href = 'home.html';
            } catch (error) {
                console.error('[v0] Checkout error:', error);
                alert('Failed to place order. Please try again.');
            }
        });

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }
    </script>
</body>
</html>
